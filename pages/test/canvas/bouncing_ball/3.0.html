<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Bouncing Ball 3.0</title>
  <meta name="description" content="[Bouncing Ball v3.0] 공 튀기기 테스트">
  <style>
    #buttons {
      margin: 0;
      position: absolute;
    }

    #buttons button {
      width: 80px;
      height: 20px;
    }

    #setting-forms {
      position: absolute;
      margin-top: 40px;
    }

    #setting-forms input {
      padding: 2px;
      background: #DDDCCC;
      border-radius: 5px;
    }

    #setting-forms input::-webkit-outer-spin-button,
    #setting-forms input::-webkit-inner-spin-button {
      -webkit-appearance: none;
    }

    #setting-forms span {
      padding: 5px;
      background: #EEEDDD;
      border-radius: 5px;
    }

    canvas {
      background: #FFFAF0;
      width: 80vw;
      height: 80vh;
      border: 1px dotted black;
      margin-top: 10vh;
      margin-left: 2vw;
    }
  </style>

</head>

<body>
  <div id="buttons">
    <button onClick="location.href='2.5.html'">Prev</button>
    <button onClick="generate()">Gen</button>
    <button onClick="toggle()">Toggle</button>
    <button onClick="location.href='#'">Next</button>
  </div>
  <div id="setting-forms">
    <span> count
      <input id="icount" type="number" min="1" max="999" value="1" onchange="generate()" required style="width:30px"></input>
    </span>
    <span> speed
      <input id="ispeed" type="number" min="1" max="999" value="100" onchange="generate()" required style="width:25px"></input>
    </span>
    <span> radius
      <input id="iradius1" type="number" min="1" max="99" value="1" onchange="generate()" required style="width:20px"></input>
      ~
      <input id="iradius2" type="number" min="1" max="99" value="5" onchange="generate()" required style="width:20px"></input>
    </span>
  </div>
  <canvas id="canvas_ball"></canvas>
  <script>
    var canvas = document.getElementById('canvas_ball');
    var context = canvas.getContext('2d');
    var timeout = null;
    var balls = [];

    var Ball = function(x, y, speed, angle, radius, color) {
      this.x = x;
      this.y = y;
      this.speed = speed;
      this.angle = angle;
      this.radius = radius;
      this.color = color;
    }
    Ball.prototype.relativeRadius = function() {
      return this.radius * Math.sqrt(canvas.clientWidth * canvas.clientHeight, 2) / 100;
    }
    Ball.prototype.colision = function(ball) {
      return Math.sqrt(Math.pow(this.x - ball.x, 2) + Math.pow(this.y - ball.y, 2)) < (this.relativeRadius() + ball.relativeRadius());
    }

    function generate() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      balls = [];
      var tryTime = 0;
      while (balls.length < icount.value && tryTime < 10000) {
        var x = rand(0, canvas.clientWidth);
        var y = rand(0, canvas.clientHeight);
        var dX = rand(1, 10) * (rand(0, 1) ? 1 : -1);
        var dY = rand(1, 10) * (rand(0, 1) ? 1 : -1);
        var rad1 = parseInt(iradius1.value);
        var rad2 = parseInt(iradius2.value);
        var radius = rand(Math.min(rad1, rad2), Math.max(rad1, rad2));
        var color = 'rgb(' + [rand(0, 255), rand(0, 255), rand(0, 255)] + ')';

        var ball = new Ball(x, y, parseInt(ispeed.value), rand(1, 360), radius + 1, color);
        var relativeRadius = radius * Math.sqrt(canvas.clientWidth * canvas.clientHeight, 2) / 100;
        var colision = ball.x < relativeRadius || ball.x > canvas.width - relativeRadius || ball.y < relativeRadius || ball.y > canvas.height - relativeRadius;

        if (!colision) {
          for (index in balls) {
            if (ball.colision(balls[index])) {
              colision = true;
              break;
            }
          }
        }
        if (!colision) {
          ball.radius--;
          balls.push(ball);
        } else {
          tryTime++;
        }
      }
      render();
    }

    function move() {
      for (index in balls) {
        var ball = balls[index];
        var relativeRadius = ball.relativeRadius();
        var colision = false;
        for (index in balls) {
          var ball2 = balls[index];
          if (ball != ball2 && ball.colision(ball2)) {
            colision = true;
            ball.angle = Math.atan2(ball2.y - ball.y, ball2.x - ball.x) * 180 / Math.PI;
            //ball2.angle = Math.atan2(ball.y - ball2.y, ball.x - ball2.x) * 180 / Math.PI;
            break;
          }
        }
        ball.x += -Math.sin(ball.angle) * ball.speed / 100;
        ball.y += -Math.cos(ball.angle) * ball.speed / 100;
        if (ball.x < relativeRadius) {
          ball.x = relativeRadius;
        } else if (ball.x > canvas.width - relativeRadius) {
          ball.x = canvas.width - relativeRadius;
        }
        if (ball.y < relativeRadius) {
          ball.y = relativeRadius;
        } else if (ball.y > canvas.height - relativeRadius) {
          ball.y = canvas.height - relativeRadius;
        }
      }
      timeout = setTimeout(onTick, 1);
    }

    function render() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      context.clearRect(0, 0, canvas.width, canvas.height);

      for (index in balls) {
        var ball = balls[index];

        context.beginPath();
        context.fillStyle = ball.color;
        context.arc(ball.x, ball.y, ball.relativeRadius(), 0, Math.PI * 2, true);
        context.fill();
        context.font = "20px Arial";
        context.fillStyle = 'red';
        context.fillText(ball.angle + "º", ball.x, ball.y);
        context.closePath();
      }
    }

    function onTick() {
      move();
      render();
    }

    function toggle() {
      if (timeout)
        timeout = clearTimeout(timeout);
      else
        onTick();
    }

    function rand(min, max) {
      return Math.floor(Math.random() * (max - min + 1) + min);
    }
    generate();
    toggle();
  </script>
</body>

</html>
